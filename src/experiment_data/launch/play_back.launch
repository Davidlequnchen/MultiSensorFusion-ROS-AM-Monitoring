<launch>
  <arg name="image_processing" default="true"/>
  <arg name="contour_extract" default="false"/>
  <arg name="convex_hull_extract" default="false"/>
  <arg name="moment_extract" default="false"/>
  <arg name="temperature_extract" default="true"/>
  <arg name="image_topic_converted"  default="/infratec/image_converted_mono8_modified" />
  <arg name="image_topic_raw"  default="/infratec/image_raw_calibrated_cropped" />

  <arg name="threshold_type" default="0" doc="Specify threshold types. 0: Binary threshold, 1: Binary inverted threshold, 2: Threshold truncated, 3: Threshold to zero, 4: Threshold to zero inverted" />
  <arg name="threshold" default="170" doc="threshold value"/>
  <!-- 170 for others, 60 for experiment1 -->

  <!-- Parameter service, this will overwrite every thing previously defined -->
  <rosparam command="load" file="$(find thermal_monitoring)/config/thermal_camera_parameter.yaml" />

  <!-- step 0:  ros bag play -->
  <node pkg="rosbag" type="play" name="rosbag" required="true" 
        args="/media/chenlequn/Lequn_HD/Research_Projects/multimodal_monitoring/data/experiment_2_raw_thermal.bag"/>

  <!-- step 1: calibrate the raw temperature -->
  <node name="ir_image_raw_calibrate" pkg="infratec_image_processing" type="ir_image_raw_calibrate.py" output="screen" >
    <param name="thermal_image" type="str" value="/infratec/image_raw"/>
    <param name="thermal_image_calibrated" type="str" value="/infratec/image_raw_calibrated"/>
    <param name="thermal_image_calibrated_cropped" type="str" value="/infratec/image_raw_calibrated_cropped"/>
    <param name="epsilon_original" type="double" value="0.35"/>
    <param name="epsilon_new" type="double" value="0.5"/>
  </node>
  
  <!-- step 2: convert the image to mono grey scale -->
  <node name="infratec_image_convert_mono" pkg="infratec_image_processing" type="irb_image_convert_mono.py" output="screen" >
    <param name="thermal_image" type="str" value="/infratec/image_raw_calibrated"/>
    <param name="mono_thermal_image" type="str" value="/infratec/image_converted_mono8_modified"/>
  </node>
  
  <!-- step 3: visualization -->
  <node name="image_view" pkg="image_view" type="image_view" respawn="false" output="screen">
    <remap from="image" to="/infratec/image_raw_calibrated"/>
    <param name="autosize" value="true" />
  </node>

  <node name="image_view2" pkg="image_view" type="image_view" respawn="false" output="screen">
    <remap from="image" to="/infratec/image_raw"/>
    <param name="autosize" value="true" />
  </node>

  <node name="image_view3" pkg="image_view" type="image_view" respawn="false" output="screen">
    <remap from="image" to="/infratec/image_converted_mono8_modified"/>
    <param name="autosize" value="true" />
  </node>


  <!-- step 4: Feature extraction -->
  <include file="$(find infratec_image_processing)/launch/in_situ_processing.launch" if="$(arg image_processing)">
    <arg name="contour_extract"  value="$(arg contour_extract)"/>
    <arg name="convex_hull_extract"  value="$(arg convex_hull_extract)"/>
    <arg name="temperature_extract"  value="$(arg temperature_extract)"/>
    <arg name="threshold"  value="$(arg threshold)"/>
    <arg name="threshold_type"  value="$(arg threshold_type)"/>
    <arg name="image_topic_converted"  value="$(arg image_topic_converted)"/>
    <!-- here needs the raw calibrated and cropped image -->
    <arg name="image_topic_raw"  value="$(arg image_topic_raw)"/>
  </include>


  <!-- step 5: Data recording -->
  <node pkg="rosbag" type="record" name="rosbag_record_multimodal_monitoring_experiment" 
  args="-O /media/chenlequn/Lequn_HD/Research_Projects/multimodal_monitoring/data_post_processed/experiment_1_meltpool.bag 
    /infratec/temperature_feature" />
    <!-- /infratec/image_raw /infratec/image_converted_mono8 /cartesian_position /cartesian_velocity 
      /general_contours/max_contour_area /convex_hull/hull_area -->

  <node name="extract" pkg="image_view" type="extract_images" respawn="false" required="true" output="screen" cwd="ROS_HOME">
    <remap from="image" to="/infratec/image_converted_mono8_modified"/>
  </node>

  <!-- <node name="video_recorder" pkg="image_view" type="video_recorder" respawn="false" required="true" output="screen">
    <remap from="image" to="/infratec/image_converted_mono8_modified"/>
    <param name="filename" value="image_converted_mono8_modified.avi" />
    <param name="fps" value="30" />
  </node> -->
  

  <!-- <node name="plot_multimodal" pkg="plotjuggler" type="plotjuggler"/> -->



  
</launch>